<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>J-Secure Cloud — Admin</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background:#0b1220; color:#e5e7eb; }
    header { padding:16px 20px; background:#0f1b33; position:sticky; top:0; border-bottom:1px solid #22304d; }
    h1 { margin:0; font-size:18px; }
    main { padding:20px; max-width:1100px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin:14px 0 20px; }
    .card { background:#0f1b33; border:1px solid #22304d; border-radius:12px; padding:14px; }
    .k { color:#9ca3af; font-size:12px; }
    .v { font-size:20px; margin-top:6px; }
    table { width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; }
    th, td { padding:10px 10px; border-bottom:1px solid #22304d; }
    th { text-align:left; color:#9ca3af; font-weight:600; font-size:12px; }
    tr:hover td { background:#0b1730; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    button { background:#1f2a44; color:#e5e7eb; border:1px solid #33456a; border-radius:10px; padding:8px 10px; cursor:pointer; }
    button:hover { background:#243356; }
    button.danger { background:#3a1a1a; border-color:#6b2a2a; }
    button.danger:hover { background:#4a2020; }
    input { background:#0b1730; border:1px solid #22304d; color:#e5e7eb; border-radius:10px; padding:8px 10px; }
    .muted { color:#9ca3af; font-size:12px; }
    .ok { color:#34d399; }
    .err { color:#f87171; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #33456a; }
    .pill.admin { border-color:#7c3aed; color:#c4b5fd; }
    .pill.blocked { border-color:#ef4444; color:#fecaca; }
  </style>
</head>
<body>
<header>
  <h1>J-Secure Cloud — Admin</h1>
  <div class="muted">Utilise ton cookie JWT (même navigateur). Si tu n’es pas connecté, va d’abord sur la page login.</div>
</header>

<main>
  <div class="row">
    <button id="refresh">Rafraîchir</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="k">Utilisateurs</div>
      <div class="v" id="usersCount">—</div>
    </div>
    <div class="card">
      <div class="k">Fichiers</div>
      <div class="v" id="filesCount">—</div>
    </div>
    <div class="card">
      <div class="k">Total bytes</div>
      <div class="v" id="totalBytes">—</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div>
        <div style="font-weight:700;">Utilisateurs</div>
        <div class="muted">Block / Unblock / Quota / Delete</div>
      </div>
      <input id="filter" placeholder="filtrer par email..." />
    </div>

    <div style="margin-top:12px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Flags</th>
            <th>Quota</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function fmtBytes(n) {
    if (n === null || n === undefined) return "—";
    if (n === 0) return "0";
    const units = ["B","KB","MB","GB","TB"];
    let i = 0; let v = Number(n);
    while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
    return v.toFixed(i === 0 ? 0 : 2) + " " + units[i];
  }

  async function api(path, opts={}) {
    const res = await fetch(path, {
      ...opts,
      credentials: "include", // IMPORTANT: cookie JWT
      headers: {
        "content-type": "application/json",
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    if (!res.ok) {
      const msg = (data && data.message) ? data.message : (typeof data === "string" ? data : "error");
      throw new Error(`${res.status} ${res.statusText} — ${msg}`);
    }
    return data;
  }

  async function loadAll() {
    $("status").textContent = "Chargement…";
    $("status").className = "muted";
    const [stats, users] = await Promise.all([
      api("/api/admin/stats"),
      api("/api/admin/users")
    ]);
    $("usersCount").textContent = stats.users_count;
    $("filesCount").textContent = stats.files_count;
    $("totalBytes").textContent = fmtBytes(stats.total_bytes);

    window.__users = users;
    renderUsers();
    $("status").textContent = "OK";
    $("status").className = "ok";
  }

  function renderUsers() {
    const q = $("filter").value.trim().toLowerCase();
    const users = (window.__users || []).filter(u => !q || u.email.toLowerCase().includes(q));
    const body = $("usersBody");
    body.innerHTML = "";
    for (const u of users) {
      const tr = document.createElement("tr");

      const flags = [];
      if (u.is_admin === 1) flags.push(`<span class="pill admin">admin</span>`);
      if (u.is_blocked === 1) flags.push(`<span class="pill blocked">blocked</span>`);
      const flagsHtml = flags.length ? flags.join(" ") : `<span class="muted">—</span>`;

      tr.innerHTML = `
        <td>${u.id}</td>
        <td>${u.email}</td>
        <td>${flagsHtml}</td>
        <td>${u.quota_bytes === null ? "NULL" : fmtBytes(u.quota_bytes)}</td>
        <td>
          ${u.is_blocked === 1
            ? `<button data-act="unblock" data-email="${u.email}">Unblock</button>`
            : `<button data-act="block" data-email="${u.email}">Block</button>`
          }
          <button data-act="quota" data-email="${u.email}">Quota</button>
          <button class="danger" data-act="delete" data-email="${u.email}">Delete</button>
        </td>
      `;
      body.appendChild(tr);
    }
  }

  async function onAction(act, email) {
    try {
      $("status").textContent = `${act} ${email}…`;
      $("status").className = "muted";

      if (act === "block") {
        await api(`/api/admin/users/${encodeURIComponent(email)}/block`, { method: "POST", body: "{}" });
      }
      if (act === "unblock") {
        await api(`/api/admin/users/${encodeURIComponent(email)}/unblock`, { method: "POST", body: "{}" });
      }
      if (act === "quota") {
        const v = prompt("Quota en bytes (ex: 1073741824 = 1GB). Vide = NULL", "");
        if (v === null) return;
        const payload = v.trim() === "" ? { quota_bytes: null } : { quota_bytes: Number(v.trim()) };
        await api(`/api/admin/users/${encodeURIComponent(email)}/quota`, { method: "POST", body: JSON.stringify(payload) });
      }
      if (act === "delete") {
        if (!confirm(`Supprimer l'utilisateur (DB) ${email} ?`)) return;
        // IMPORTANT: ton endpoint delete est en POST (pas DELETE)
        await api(`/api/admin/users/${encodeURIComponent(email)}/delete`, { method: "POST", body: "{}" });
      }

      await loadAll();
    } catch (e) {
      $("status").textContent = "Erreur: " + e.message;
      $("status").className = "err";
      console.error(e);
    }
  }

  $("refresh").addEventListener("click", loadAll);
  $("filter").addEventListener("input", renderUsers);
  $("usersBody").addEventListener("click", (ev) => {
    const btn = ev.target.closest("button");
    if (!btn) return;
    onAction(btn.dataset.act, btn.dataset.email);
  });

  loadAll().catch(e => {
    $("status").textContent = "Erreur: " + e.message + " (Tu es connecté ?)";
    $("status").className = "err";
  });
</script>
</body>
</html>
